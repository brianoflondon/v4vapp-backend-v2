# Error Code Manager

## Overview

The `ErrorCodeManager` is a singleton class that provides centralized error code tracking with MongoDB persistence. It was introduced to replace the simple `error_codes: dict` in `InternalConfig` with a more robust system that:

1. **In-memory tracking** - Fast lookups for active error suppression (existing behavior)
2. **MongoDB persistence** - Historical record of all errors and their resolutions
3. **Backward compatibility** - Dict-like interface for existing code

## Architecture

### Components

```
src/v4vapp_backend_v2/config/
â”œâ”€â”€ error_code_class.py       # ErrorCode dataclass with MongoDB serialization
â”œâ”€â”€ error_code_manager.py     # ErrorCodeManager singleton
â”œâ”€â”€ mylogger.py               # ErrorTrackingFilter integration
â””â”€â”€ setup.py                  # InternalConfig integration
```

### Data Flow

```
Log event with error_code
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ErrorTrackingFilterâ”‚ (in mylogger.py)
â”‚                   â”‚
â”‚ - Check if new    â”‚
â”‚ - Check re_alert  â”‚
â”‚ - Clear on resolveâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ErrorCodeManager  â”‚
â”‚                   â”‚
â”‚ - In-memory dict  â”‚â”€â”€â–º Fast lookup/suppression
â”‚ - MongoDB persist â”‚â”€â”€â–º Historical tracking
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## MongoDB Schema

### Collection: `error_codes`

Each document represents an error event (either new error or cleared error):

```json
{
    "_id": ObjectId("..."),        // Auto-generated by MongoDB
    "code": "witness_api_invalid_response",
    "message": "ğŸ“¡ Invalid response from Hive API at http://...",
    "start_time": ISODate("2026-01-14T15:05:51.367Z"),
    "last_log_time": ISODate("2026-01-14T15:05:51.367Z"),
    "server_id": "v4vapp",
    "node_name": "voltage",
    "active": true,                // false when error is cleared
    "cleared_at": null,            // ISODate when cleared
    "created_at": ISODate("2026-01-14T15:05:51.370Z"),
    "updated_at": ISODate("2026-01-14T15:05:51.370Z")
}
```

### Fields

| Field           | Type     | Description                                                  |
| --------------- | -------- | ------------------------------------------------------------ |
| `code`          | string   | Error code identifier (e.g., `witness_api_invalid_response`) |
| `message`       | string   | Error message from the log                                   |
| `start_time`    | datetime | When the error first occurred                                |
| `last_log_time` | datetime | Last time this error was logged                              |
| `server_id`     | string   | Server identifier from config                                |
| `node_name`     | string   | Lightning node name from config                              |
| `active`        | boolean  | `true` for new errors, `false` when cleared                  |
| `cleared_at`    | datetime | Timestamp when error was cleared (null if active)            |
| `created_at`    | datetime | Document creation timestamp                                  |
| `updated_at`    | datetime | Last update timestamp                                        |

## Usage

### Basic Usage (via InternalConfig)

The manager is accessed through `InternalConfig.error_codes` which provides backward-compatible dict-like access:

```python
from v4vapp_backend_v2.config.setup import InternalConfig

# Check if error exists
if "witness_error" in InternalConfig().error_codes:
    error = InternalConfig().error_codes["witness_error"]
    print(f"Error active for: {error.elapsed_time}")

# Add new error (automatically persists to MongoDB)
from v4vapp_backend_v2.config.error_code_class import ErrorCode
error = ErrorCode(code="my_error", message="Something failed")
InternalConfig().error_codes.add(error)

# Remove error (automatically persists clear event to MongoDB)
InternalConfig().error_codes.remove("my_error")

# Get all active errors as dict
error_dict = InternalConfig().error_codes_to_dict()
```

### Logging with Error Codes

Error codes are typically used through the logging system with `extra` parameters:

```python
import logging
from datetime import timedelta

logger = logging.getLogger(__name__)

# Log an error with tracking (suppresses duplicates for 1 hour by default)
logger.warning(
    "Connection failed to service",
    extra={
        "error_code": "service_connection_error",
        "notification": True  # Send notification
    }
)

# Log with custom re-alert time
logger.warning(
    "API rate limited",
    extra={
        "error_code": "api_rate_limit",
        "re_alert_time": timedelta(minutes=15)  # Re-alert every 15 min
    }
)

# Clear an error when resolved
logger.info(
    "Service reconnected",
    extra={
        "error_code_clear": "service_connection_error",
        "notification": True
    }
)
```

### Querying Error History

The manager provides async methods to query historical data:

```python
from v4vapp_backend_v2.config.error_code_manager import ErrorCodeManager

manager = ErrorCodeManager()

# Get recent error history
history = await manager.get_error_history(limit=100)

# Get history for specific error code
history = await manager.get_error_history(code="witness_error", limit=50)

# Get only active (uncleared) errors from DB
active = await manager.get_error_history(active_only=True)

# Load active errors from MongoDB (useful for state recovery)
active_errors = await manager.get_active_errors_from_db()
```

## Configuration

### Enabling/Disabling Persistence

MongoDB persistence can be disabled for testing:

```python
from v4vapp_backend_v2.config.error_code_manager import ErrorCodeManager

# Disable DB persistence (useful in tests)
manager = ErrorCodeManager(db_enabled=False)

# Or configure after initialization
manager.configure(db_enabled=False)
```

### Server/Node Identification

The manager automatically picks up `server_id` and `node_name` from `InternalConfig`:

```python
manager.configure(
    server_id="my-server",      # Optional override
    node_name="my-node",        # Optional override
    db_enabled=True
)
```

## Error Handling

### Event Loop Constraints

The manager only persists to MongoDB when called from the same event loop where `InternalConfig.db` was created. This avoids the "Cannot use AsyncMongoClient in different event loop" error.

- **Main event loop**: Persistence works normally
- **Notification loop**: Persistence is skipped (in-memory tracking still works)
- **No running loop**: Persistence is skipped

### Persistence Failures

MongoDB persistence failures are logged as warnings but never break the logging system:

```
WARNING  error_code_manager: ğŸ”´ Failed to persist error code to MongoDB: ...
```

The in-memory error tracking continues to work even if MongoDB is unavailable.

## Testing

### Test Setup

Tests should reset the singleton between test cases:

```python
import pytest
from v4vapp_backend_v2.config.error_code_manager import ErrorCodeManager

@pytest.fixture(autouse=True)
def reset_manager(monkeypatch):
    monkeypatch.setattr(
        "v4vapp_backend_v2.config.error_code_manager.ErrorCodeManager._instance",
        None
    )
    yield
    monkeypatch.setattr(
        "v4vapp_backend_v2.config.error_code_manager.ErrorCodeManager._instance",
        None
    )
```

### Mocking MongoDB

For unit tests, mock the MongoDB operations:

```python
from unittest.mock import AsyncMock, patch

@pytest.mark.asyncio
async def test_persist():
    manager = ErrorCodeManager(db_enabled=True)

    mock_collection = AsyncMock()
    mock_db = MagicMock()
    mock_db.__getitem__ = MagicMock(return_value=mock_collection)

    with patch("v4vapp_backend_v2.config.setup.InternalConfig.db", mock_db):
        await manager._async_persist_add(error)
        mock_collection.insert_one.assert_called_once()
```

## Files Modified/Created

### New Files

- `src/v4vapp_backend_v2/config/error_code_manager.py` - Main manager class
- `tests/mylogger/test_error_code_manager.py` - Comprehensive tests
- `docs/error_code_manager.md` - This documentation

### Modified Files

- `src/v4vapp_backend_v2/config/error_code_class.py` - Added `to_mongo_doc()` and `from_mongo_doc()` methods
- `src/v4vapp_backend_v2/config/setup.py` - Replaced `error_codes` dict with `ErrorCodeManager`
- `src/v4vapp_backend_v2/config/mylogger.py` - Updated `ErrorTrackingFilter` to use `manager.add()`
- `tests/mylogger/test_custom_notification_handler.py` - Updated fixtures for singleton reset

## See Also

- [src/v4vapp_backend_v2/config/error_code_manager.py](../src/v4vapp_backend_v2/config/error_code_manager.py)
- [src/v4vapp_backend_v2/config/mylogger.py](../src/v4vapp_backend_v2/config/mylogger.py)
- [tests/mylogger/test_error_code_manager.py](../tests/mylogger/test_error_code_manager.py)
