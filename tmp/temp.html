'{% extends "base.html" %}\n\n{% block content %}\n\n<div class="container-fluid">\n <div class="row">\n <div
            class="col-12">\n <!-- Users Table -->\n <div class="card">\n <div
                    class="card-header d-flex align-items-start">\n <div>\n <h5 class="mb-0">\n <i
                                class="bi bi-people me-2"></i>\n VSC Liability Users\n </h5>\n <small
                            class="text-muted">Users with VSC Liability accounts and their current balances</small>\n
                        <div class="mt-2">\n <strong>Limits:</strong> {% for entry in limit_entries %}{{ entry.label
                            }}{% if not\n loop.last %} | {% endif %}{% endfor %}\n </div>\n
                    </div>\n
                    <!-- Controls and selectors -->\n <div class="d-flex align-items-center">\n <input type="text"
                            id="search-input" class="form-control form-control-sm" \n placeholder="Search users..."
                            value="" style="width: 200px;">\n </div>\n <div class="d-flex align-items-center ms-3"
                        style="flex: 0 0 50%;">\n <div class="me-3">\n <select id="active-period"
                                class="form-select form-select-sm">\n <option value="all">ALL</option>\n <option
                                    value="6months">6 months</option>\n <option value="4months">4 months</option>\n
                                <option value="1month">1 month</option>\n
                            </select>\n </div>\n <div class="form-check me-3">\n <input class="form-check-input"
                                type="checkbox" id="active-only">\n <label class="form-check-label" for="active-only">\n
                                Show only
                                active users\n </label>\n </div>\n <div class="ms-2">\n <select id="display-currency"
                                class="form-select form-select-sm">\n <option value="SATS">SATS</option>\n <option
                                    value="USD">USD</option>\n </select>\n </div>\n </div>\n
                </div>\n <div class="card-body mt-3 position-relative">\n
                    <!-- Loading Overlay - covers entire data section -->\n
                    <div id="loading-overlay" class="table-loading-overlay">\n <div class="loading-content">\n <div
                                class="spinner-border text-primary" role="status">\n <span
                                    class="visually-hidden">Loading...</span>\n </div>\n <div class="loading-text mt-3">
                                \n <h5>Loading VSC Liability Users...</h5>\n <p class="text-muted">Fetching user
                                    balances and transaction data</p>\n </div>\n </div>\n </div>\n
                    <!-- Summary Stats -->\n <div class="row mt-2 mb-5">\n <div class="col-md-3">\n <div
                                class="card bg-light">\n <div class="card-body text-center">\n <div
                                        class="h4 text-primary" id="total-users">0</div>\n <small
                                        class="text-muted">Total Users</small>\n </div>\n </div>\n </div>\n <div
                            class="col-md-3">\n <div class="card bg-light">\n <div class="card-body text-center">\n <div
                                        class="h4 text-success" id="active-users">0</div>\n <small
                                        class="text-muted">Active Users</small>\n </div>\n </div>\n </div>\n <div
                            class="col-md-3">\n <div class="card bg-light">\n <div class="card-body text-center">\n <div
                                        class="h4 text-info" id="total-positive-balance">0</div>\n <small
                                        class="text-muted">Total Positive Balance</small>\n </div>\n </div>\n </div>\n
                        <div class="col-md-3">\n <div class="card bg-light">\n <div class="card-body text-center">\n
                                    <div class="h4 text-warning" id="error-count">0</div>\n <small
                                        class="text-muted">Errors</small>\n
                                </div>\n </div>\n </div>\n
                    </div>\n <div class="table-responsive">\n <table class="table table-hover">\n <thead>\n <tr>\n <th
                                        scope="col" class="sortable" data-sort="user">User <i\n
                                            class="bi bi-chevron-expand"></i>
                                    </th>\n {% for entry in limit_entries %}\n <th scope="col" class="text-center">{{
                                        entry.label }} (%)</th>\n {% endfor %}\n <th scope="col"
                                        class="sortable text-end" data-sort="balance">Balance (<span\n
                                            id="balance-currency-label">SATS</span>) <i\n class="bi bi-chevron-expand">
                                                </i></th>\n <th scope="col" class="sortable text-end" data-sort="age">
                                        Age <i\n class="bi bi-chevron-expand"></i></th>\n <th scope="col"
                                        class="text-center">Status</th>\n <th scope="col" class="text-center">Actions
                                    </th>\n </tr>\n </thead>\n <tbody id="users-tbody">\n
                                <!-- Data will be populated by JavaScript -->\n
                            </tbody>\n </table>\n </div>\n\n
                </div>
                \n </div>\n </div>\n </div>\n</div>\n\n
<script>\n    document.addEventListener(\'DOMContentLoaded\', function () {\n        const searchInput = document.getElementById(\'search-input\');\n        const activeOnlyCheckbox = document.getElementById(\'active-only\');\n        const tbody = document.getElementById(\'users-tbody\');\n        const totalUsersEl = document.getElementById(\'total-users\');\n        const activeUsersEl = document.getElementById(\'active-users\');\n        const totalBalanceEl = document.getElementById(\'total-positive-balance\');\n        const errorCountEl = document.getElementById(\'error-count\');\n        const loadingOverlay = document.getElementById(\'loading-overlay\');\n        const displayCurrencySelect = document.getElementById(\'display-currency\');\n        const balanceCurrencyLabel = document.getElementById(\'balance-currency-label\');\n\n        let currentSort = { column: \'user\', direction: \'asc\' };\n        let usersData = [];\n        let currentNow = null;\n        let currentCurrency = \'SATS\'; // Default currency\n\n        // Load user data asynchronously\n        async function loadUserData() {\n            try {\n                console.log(\'Starting to load user data...\');\n                const response = await fetch(\'/admin/users/data\');\n                console.log(\'Fetch response:\', response);\n                console.log(\'Response status:\', response.status);\n                console.log(\'Response headers:\', response.headers);\n\n                if (!response.ok) {\n                    throw new Error(`HTTP error! status: ${response.status}`);\n                }\n\n                const data = await response.json();\n                console.log(\'Received data:\', data);\n\n                usersData = data.users_data;\n                currentNow = new Date(data.now);\n\n                // Populate the table\n                populateTable(usersData);\n\n                // Update summaries\n                updateSummaries();\n\n                // Add a delay to ensure user sees the loaded data before hiding overlay\n                setTimeout(function () {\n                    if (loadingOverlay) {\n                        loadingOverlay.style.opacity = \'0\';\n                        setTimeout(function () {\n                            loadingOverlay.style.display = \'none\';\n                        }, 300);\n                    }\n                }, 500); // Increased delay to 500ms to show loaded data\n\n            } catch (error) {\n                console.error(\'Error loading user data:\', error);\n                // Hide loading overlay even on error\n                if (loadingOverlay) {\n                    loadingOverlay.style.display = \'none\';\n                }\n                // Show error message in the table\n                tbody.innerHTML = `\n                    <tr>\n                        <td colspan="9" class="text-center py-5">\n                            <div class="h1 text-danger mb-3">‚ö†Ô∏è</div>\n                            <h4 class="text-danger">Error Loading User Data</h4>\n                            <p class="text-muted">Failed to load user data. Please refresh the page to try again.</p>\n                            <p class="text-muted small">Error details: ${error.message}</p>\n                        </td>\n                    </tr>\n                `;\n            }\n        }\n\n        function populateTable(data) {\n            tbody.innerHTML = \'\';\n\n            if (data.length === 0) {\n                // Show empty state in the table\n                const emptyRow = document.createElement(\'tr\');\n                emptyRow.innerHTML = `\n                    <td colspan="9" class="text-center py-5">\n                        <div class="h1 text-muted mb-3">üë•</div>\n                        <h4 class="text-muted">No VSC Liability Users Found</h4>\n                        <p class="text-muted">There are currently no users with VSC Liability accounts in the system.</p>\n                    </td>\n                `;\n                tbody.appendChild(emptyRow);\n                return;\n            }\n\n            data.forEach(user => {\n                // Add limit warning row if needed\n                if (!user.limit_ok) {\n                    const limitRow = document.createElement(\'tr\');\n                    limitRow.className = \'table-row-limit-not-ok\';\n                    limitRow.setAttribute(\'data-sub\', user.sub);\n                    limitRow.innerHTML = `\n                        <td></td>\n                        <td colspan="4" class="text-center">\n                            <small style="margin: 0; font-size: 0.75rem;">${user.limit_sats ? user.limit_sats.join(\', \') : \'\'} ${user.next_limit_expiry || \'\'}</small>\n                        </td>\n                        <td></td>\n                    `;\n                    tbody.appendChild(limitRow);\n                }\n\n                // Add main user row\n                const row = document.createElement(\'tr\');\n                row.setAttribute(\'data-sub\', user.sub);\n                row.setAttribute(\'data-balance\', currentCurrency === \'SATS\' ? (user.balance_sats || 0) : (user.balance_usd || 0));\n                row.setAttribute(\'data-has-transactions\', (user.has_transactions || false).toString());\n                row.setAttribute(\'data-error\', (user.error ? \'true\' : \'false\'));\n                row.setAttribute(\'data-last-transaction\', user.last_transaction_date || \'\');\n                row.setAttribute(\'data-last-transaction-age\', user.last_transaction_date ? Math.floor((currentNow - new Date(user.last_transaction_date)) / (1000 * 60 * 60 * 24)) : 999999);\n\n                row.innerHTML = `\n                    <td>\n                        <strong>\n                            <a href="/admin/accounts/balance/user/${user.sub}" class="text-decoration-none">\n                                ${user.sub}\n                            </a>\n                        </strong>\n                    </td>\n                    ${user.limit_percents ? user.limit_percents.map((percent, index) => `\n                        <td class="text-center">\n                            <span class="me-2">${percent}%</span>\n                            <small class="text-muted">${user.limit_sats ? user.limit_sats[index] : \'\'}</small>\n                        </td>\n                    `).join(\'\') : \'<td colspan="4" class="text-center">-</td>\'}\n                    <td class="text-end">\n                        ${user.balance_sats !== null && user.balance_sats !== undefined ?\n                        (currentCurrency === \'SATS\' ?\n                            (user.balance_sats > 0 ? `<span class="text-success fw-bold">${user.balance_sats_fmt}</span>` :\n                                user.balance_sats < 0 ? `<span class="text-danger fw-bold">${user.balance_sats_fmt}</span>` :\n                                    `<span class="text-muted">${user.balance_sats_fmt}</span>`) :\n                            (user.balance_usd !== null && user.balance_usd !== undefined ?\n                                (user.balance_usd > 0 ? `<span class="text-success fw-bold">$${user.balance_usd_fmt}</span>` :\n                                    user.balance_usd < 0 ? `<span class="text-danger fw-bold">$${user.balance_usd_fmt}</span>` :\n                                        `<span class="text-muted">$${user.balance_usd_fmt}</span>`) :\n                                \'<span class="text-warning">Error</span>\')) :\n                        \'<span class="text-warning">Error</span>\'}\n                    </td>\n                    <td class="text-end">\n                        ${user.last_transaction_date ?\n                        `${Math.floor((currentNow - new Date(user.last_transaction_date)) / (1000 * 60 * 60 * 24))} days` :\n                        \'Never\'}\n                    </td>\n                    <td class="text-center">\n                        ${user.error ?\n                        \'<span class="badge bg-danger">Error</span>\' :\n                        (user.has_transactions ?\n                            \'<span class="badge bg-success">Active</span>\' :\n                            \'<span class="badge bg-secondary">No Activity</span>\')}\n                    </td>\n                    <td class="text-center">\n                        <a href="/admin/accounts/balance/user/${user.sub}" class="btn btn-sm btn-outline-primary">\n                            <i class="bi bi-eye me-1"></i>\n                            View Details\n                        </a>\n                    </td>\n                `;\n\n                tbody.appendChild(row);\n            });\n        }\n\n        function formatBalance(sats) {\n            if (sats >= 1000000) {\n                return (sats / 1000000).toFixed(1) + \'M\';\n            } else if (sats >= 1000) {\n                return Math.floor(sats / 1000) + \'k\';\n            } else {\n                return sats.toString();\n            }\n        }\n\n        function sortRows(column, direction) {\n            if (!usersData.length) return;\n\n            usersData.sort((a, b) => {\n                let aVal, bVal;\n                if (column === \'user\') {\n                    aVal = a.sub.toLowerCase();\n                    bVal = b.sub.toLowerCase();\n                } else if (column === \'balance\') {\n                    aVal = currentCurrency === \'SATS\' ? (a.balance_sats || 0) : (a.balance_usd || 0);\n                    bVal = currentCurrency === \'SATS\' ? (b.balance_sats || 0) : (b.balance_usd || 0);\n                } else if (column === \'age\') {\n                    aVal = a.last_transaction_date ? Math.floor((currentNow - new Date(a.last_transaction_date)) / (1000 * 60 * 60 * 24)) : 999999;\n                    bVal = b.last_transaction_date ? Math.floor((currentNow - new Date(b.last_transaction_date)) / (1000 * 60 * 60 * 24)) : 999999;\n                }\n\n                if (direction === \'asc\') {\n                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;\n                } else {\n                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;\n                }\n            });\n\n            populateTable(usersData);\n        }\n\n        function filterAndUpdate() {\n            if (!usersData.length) return;\n\n            const searchTerm = searchInput.value.toLowerCase().trim();\n            const activeOnly = activeOnlyCheckbox.checked;\n            const activePeriod = document.getElementById(\'active-period\').value;\n\n            // Calculate cutoff date for active period\n            let cutoffDate = null;\n            if (activePeriod !== \'all\') {\n                const now = new Date();\n                if (activePeriod === \'1month\') {\n                    cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n                } else if (activePeriod === \'4months\') {\n                    cutoffDate = new Date(now.getTime() - 120 * 24 * 60 * 60 * 1000);\n                } else if (activePeriod === \'6months\') {\n                    cutoffDate = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);\n                }\n            }\n\n            const filteredData = usersData.filter(user => {\n                const matchesSearch = user.sub.toLowerCase().includes(searchTerm);\n                const isActive = user.has_transactions;\n                let matchesPeriod = true;\n\n                if (cutoffDate && user.last_transaction_date) {\n                    const txDate = new Date(user.last_transaction_date);\n                    matchesPeriod = txDate >= cutoffDate;\n                } else if (cutoffDate && !user.last_transaction_date) {\n                    matchesPeriod = false; // No transaction date, not active in period\n                }\n\n                return matchesSearch && (!activeOnly || isActive) && matchesPeriod;\n            });\n\n            populateTable(filteredData);\n            updateSummaries(filteredData);\n        }\n\n        function updateSummaries(data = usersData) {\n            let totalUsers = data.length;\n            let activeUsers = data.filter(u => u.has_transactions).length;\n            let totalPositiveBalance = 0;\n            let totalPositiveBalanceFmt = \'0\';\n\n            if (currentCurrency === \'SATS\') {\n                totalPositiveBalance = data\n                    .filter(u => u.balance_sats && u.balance_sats > 0)\n                    .reduce((sum, u) => sum + u.balance_sats, 0);\n                totalPositiveBalanceFmt = totalPositiveBalance > 0 ? formatBalance(totalPositiveBalance) : \'0\';\n            } else {\n                totalPositiveBalance = data\n                    .filter(u => u.balance_usd && u.balance_usd > 0)\n                    .reduce((sum, u) => sum + u.balance_usd, 0);\n                totalPositiveBalanceFmt = totalPositiveBalance > 0 ? `$${totalPositiveBalance.toFixed(2)}` : \'$0.00\';\n            }\n\n            let errorCount = data.filter(u => u.error).length;\n\n            totalUsersEl.textContent = totalUsers;\n            activeUsersEl.textContent = activeUsers;\n            totalBalanceEl.textContent = totalPositiveBalanceFmt;\n            errorCountEl.textContent = errorCount;\n        }\n\n        // Sortable headers\n        document.querySelectorAll(\'.sortable\').forEach(th => {\n            th.addEventListener(\'click\', function () {\n                const column = this.dataset.sort;\n                if (currentSort.column === column) {\n                    currentSort.direction = currentSort.direction === \'asc\' ? \'desc\' : \'asc\';\n                } else {\n                    currentSort.column = column;\n                    currentSort.direction = \'asc\';\n                }\n\n                // Update icons\n                document.querySelectorAll(\'.sortable i\').forEach(icon => {\n                    icon.className = \'bi bi-chevron-expand\';\n                });\n                const icon = this.querySelector(\'i\');\n                icon.className = currentSort.direction === \'asc\' ? \'bi bi-chevron-up\' : \'bi bi-chevron-down\';\n\n                sortRows(currentSort.column, currentSort.direction);\n                filterAndUpdate();\n            });\n        });\n\n        // Event listeners\n        searchInput.addEventListener(\'input\', filterAndUpdate);\n        activeOnlyCheckbox.addEventListener(\'change\', filterAndUpdate);\n        document.getElementById(\'active-period\').addEventListener(\'change\', filterAndUpdate);\n        displayCurrencySelect.addEventListener(\'change\', function () {\n            currentCurrency = this.value;\n            balanceCurrencyLabel.textContent = currentCurrency;\n            console.log(\'Currency changed to:\', currentCurrency);\n            console.log(\'Users data sample:\', usersData[0]);\n            populateTable(usersData);\n            updateSummaries();\n        });\n\n        // Load data initially\n        loadUserData();\n    });\n</script>
\n\n<style>
    \n .table-loading-overlay {
        \n position: absolute;
        \n top: 0;
        \n left: 0;
        \n width: 100%;
        \n height: 100%;
        \n background-color: rgba(255, 255, 255, 0.95);
        \n display: flex;
        \n justify-content: center;
        \n align-items: center;
        \n z-index: 10;
        \n backdrop-filter: blur(2px);
        \n transition: opacity 0.3s ease-out;
        \n border-radius: 0.375rem;
        \n padding: 2rem;
        \n
    }

    \n\n .table-loading-overlay .loading-content {
        \n text-align: center;
        \n padding: 2rem;
        \n background-color: white;
        \n border-radius: 0.5rem;
        \n box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        \n max-width: 400px;
        \n width: 100%;
        \n
    }

    \n\n .table-loading-overlay .loading-content .spinner-border {
        \n width: 3rem;
        \n height: 3rem;
        \n
    }

    \n\n .table-loading-overlay .loading-text h5 {
        \n color: #495057;
        \n margin-bottom: 0.5rem;
        \n
    }

    \n\n .table-loading-overlay .loading-text p {
        \n color: #6c757d;
        \n margin-bottom: 0;
        \n
    }

    \n
</style>\n\n{% endblock %}\n'
