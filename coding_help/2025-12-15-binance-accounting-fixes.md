# Binance Exchange Accounting Fixes

**Date:** December 15, 2025  
**Branch:** `feature/add-fees-accounting-for-binance-transactions`

## Overview

This session addressed several critical issues in the exchange accounting system, specifically around how trade execution data flows through the system and generates accurate ledger entries.

## Issues Identified

### 1. Ledger Entries with Zero Values
The ledger entry for exchange conversions was showing all zeros:
```json
{
  "debit_amount": 0,
  "credit_amount": 0,
  "debit_conv": {
    "hive": 0,
    "hbd": 0,
    "sats": 0,
    "msats": 0
  }
}
```

**Root Cause:** The `trade_quote` generated by `_build_trade_quote()` was incomplete. It set `btc_usd=1` and left `hbd_usd=0`, causing `CryptoConversion._compute_conversions()` to hit division by zero and silently set all values to 0.

### 2. Fee Displayed as 82 Billion Sats
Log output showed:
```
"Rebalance executed: SELL 99.000 HIVE @ 0.00000111, fee: 82,417,500,000 sats"
```

**Root Cause:** In `RebalanceResult.log_str`, the code passed `fee_msats` (824.175 msats) to `format_quote_asset()` with `fee_asset="BTC"`. The function assumed the value was in BTC and multiplied by 100,000,000, producing the absurd result.

### 3. Silent Failures in CryptoConversion
When `CryptoConversion` encountered invalid quote data (zero divisors), it silently caught the `ZeroDivisionError` and set all values to 0 without any logging.

## Changes Made

### 1. `binance_adapter.py` - Complete Trade Quote Generation

**File:** `src/v4vapp_backend_v2/conversion/binance_adapter.py`

**Method:** `_build_trade_quote()`

**Before:**
```python
def _build_trade_quote(self, base_asset, quote_asset, avg_price, raw_response):
    # Created minimal QuoteResponse with btc_usd=1, hive_usd=avg_price
    # This caused sats_hbd_p and sats_usd_p to be 0
    return QuoteResponse(
        hive_usd=avg_price,
        btc_usd=Decimal("1"),
        source=f"{self.exchange_name}_trade",
        ...
    )
```

**After:**
```python
def _build_trade_quote(self, base_asset, quote_asset, avg_price, raw_response):
    # Fetch current market quote for accurate HBD/USD/BTC rates
    all_quotes = AllQuotes()
    # ... async handling ...
    market_quote = all_quotes.quote
    
    # Calculate hive_usd that produces correct sats_hive
    # sats_hive = (SATS_PER_BTC / btc_usd) * hive_usd
    # We want: trade_sats_hive = avg_price * SATS_PER_BTC
    # So: hive_usd = avg_price * btc_usd
    btc_usd = market_quote.btc_usd
    trade_hive_usd = avg_price * btc_usd
    
    return QuoteResponse(
        hive_usd=trade_hive_usd,      # Produces correct sats_hive from trade
        hbd_usd=market_quote.hbd_usd,  # Real market rate
        btc_usd=btc_usd,               # Real market rate
        hive_hbd=market_quote.hive_hbd, # Real market rate
        source=f"{self.exchange_name}_trade",
        ...
    )
```

**Result:** The `trade_quote` now contains complete, valid market data with the `sats_hive` reflecting the actual trade execution rate.

---

### 2. `crypto_conversion.py` - Added Warning Logging

**File:** `src/v4vapp_backend_v2/helpers/crypto_conversion.py`

**Method:** `CryptoConversion._compute_conversions()`

**Changes:**
- Added warnings when `quote` is None
- Added warnings before attempting division when `sats_hive_p`, `sats_hbd_p`, or `sats_usd_p` is 0
- Added warning when `ZeroDivisionError` is caught
- All warnings include the quote source for debugging

**Example warnings added:**
```python
if self.quote.sats_hive_p == 0:
    logger.warning(
        f"CryptoConversion: sats_hive_p is 0, HIVE will be 0. "
        f"Quote source: {self.quote.source}"
    )
    self.hive = Decimal(0)
else:
    self.hive = Decimal(str(round(self.msats / (self.quote.sats_hive_p * Decimal(1000)), 5)))
```

---

### 3. `exchange_rebalance.py` - Fixed Fee Display

**File:** `src/v4vapp_backend_v2/conversion/exchange_rebalance.py`

**Property:** `RebalanceResult.log_str`

**Before:**
```python
fee_str = format_quote_asset(self.order_result.fee_msats, self.order_result.fee_asset)
# fee_msats=824.175, fee_asset="BTC" → 82,417,500,000 sats (WRONG!)
```

**After:**
```python
fee_str = format_quote_asset(self.order_result.fee_original, self.order_result.fee_asset)
# fee_original=0.00000824 BTC → 824 sats (CORRECT!)
```

---

### 4. `exchange_process.py` - Simplified Accounting Logic

**File:** `src/v4vapp_backend_v2/conversion/exchange_process.py`

**Function:** `exchange_accounting()`

**Changes:**
- Now uses `CryptoConversion` with the complete `trade_quote` instead of manually building `CryptoConv`
- Added validation that `trade_quote` is complete (checks `btc_usd > 0`)
- Falls back to fetching market quote if `trade_quote` is missing/incomplete
- Added warning logging when fallback occurs

**Key logic:**
```python
# Use trade_quote from order_result - it now contains complete market rates
if order_result.trade_quote and order_result.trade_quote.btc_usd > 0:
    trade_quote = order_result.trade_quote
else:
    all_quotes = AllQuotes()
    await all_quotes.get_all_quotes()
    trade_quote = all_quotes.quote
    logger.warning(f"trade_quote not available or incomplete, using market quote...")

# Create CryptoConversion using the complete trade_quote
crypto_conversion = CryptoConversion(
    conv_from=Currency.HIVE, value=order_result.executed_qty, quote=trade_quote
)
conv = crypto_conversion.conversion
```

---

### 5. Test Updates

**File:** `tests/conversions/test_binance_adapter.py`

**Class:** `TestBinanceAdapterBuildTradeQuote`

Updated tests to reflect new behavior:
- Tests now verify `btc_usd`, `hbd_usd`, `hive_hbd` come from market quote (not fixed values)
- Tests verify `sats_hive` is correctly calculated from trade's `avg_price`
- Removed assertions for `raw_response` since trade quotes no longer store it

---

## Technical Details

### How sats_hive is Calculated

The `QuoteResponse.sats_hive_p` property calculates:
```python
sats_per_usd = SATS_PER_BTC / btc_usd
sats_hive = sats_per_usd * hive_usd
```

For a trade where `avg_price` is HIVE in BTC:
- We want: `sats_hive = avg_price * SATS_PER_BTC`
- We achieve this by setting: `hive_usd = avg_price * btc_usd`
- Then: `sats_hive = (SATS_PER_BTC / btc_usd) * (avg_price * btc_usd) = avg_price * SATS_PER_BTC` ✓

### Async Handling in Sync Context

`_build_trade_quote()` is a sync method but needs to fetch market quotes (async). Solution:
```python
try:
    loop = asyncio.get_running_loop()
    # We're in async context, use thread pool
    with concurrent.futures.ThreadPoolExecutor() as executor:
        future = executor.submit(asyncio.run, all_quotes.get_all_quotes())
        future.result(timeout=5)
except RuntimeError:
    # No running loop, use asyncio.run directly
    asyncio.run(all_quotes.get_all_quotes())
```

---

## Testing

All 109 conversion tests pass:
```
tests/conversions/ - 109 passed, 1 skipped
```

---

## Expected Ledger Entry (After Fix)

For a SELL of 99 HIVE @ 0.00000111 BTC (111 sats/HIVE):

```json
{
  "ledger_type": "exc_conv",
  "description": "Rebalance executed: SELL 99.000 HIVE @ 0.00000111, fee: 0 sats",
  "debit_amount": 99.0,
  "debit_unit": "hive",
  "credit_amount": 10989000000,
  "credit_unit": "msats",
  "debit_conv": {
    "hive": 99.0,
    "sats": 10989.0,
    "msats": 10989000.0,
    "sats_hive": 111.0
  }
}
```

---

## Files Changed

1. `src/v4vapp_backend_v2/conversion/binance_adapter.py`
2. `src/v4vapp_backend_v2/conversion/exchange_process.py`
3. `src/v4vapp_backend_v2/conversion/exchange_rebalance.py`
4. `src/v4vapp_backend_v2/helpers/crypto_conversion.py`
5. `tests/conversions/test_binance_adapter.py`
