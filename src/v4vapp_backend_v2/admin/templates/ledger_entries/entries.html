{% extends "base.html" %} {% block extra_css %}
<style>
    .account-form {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .form-select {
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 0.9rem;
    }

    .form-check-label {
        font-weight: 500;
        color: var(--bs-body-color);
    }

    /* Entry card width control - change max-width here to adjust width (e.g., 900px). Uses width:100% so it fills small screens and caps at 900px on wide screens. Left-justified. */
    .entry-card {
        width: 100%;
        max-width: 900px;
        margin-left: 0;
        margin-right: auto;
    }

    .entry-card .card-body {
        padding: 1rem;
    }

    .entry-card .row {
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %} {% block content %}
<div class="card account-form">
    <h3 class="mb-4">
        <i class="bi bi-bank me-2"></i>
        Select Account for Balance Report
    </h3>

    <form method="get" class="needs-validation" novalidate>
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="sub_filter" class="form-label">
                        <i class="bi bi-funnel me-1"></i>
                        Filter by Sub Account
                    </label>
                    <select class="form-select" id="sub_filter" name="sub_filter" onchange="filterBySubAccount()">
                        <option value="" {% if not sub_filter %}selected{% endif %}>
                            All Sub Accounts
                        </option>
                        {% set all_subs = [] %} {% for account_type, accounts in
                        accounts_by_type.items() %} {% for account in accounts %} {% if
                        account.sub and account.sub not in all_subs %} {% set _ =
                        all_subs.append(account.sub) %} {% endif %} {% endfor %} {% endfor
                        %} {% for sub in all_subs|sort %}
                        <option value="{{ sub }}" {% if sub_filter and sub_filter==sub %}selected{% endif %}>{{ sub }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text text-muted mt-1">
                        Selecting a sub-account will clear the account selector so a search
                        will return all entries for that sub-account.
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="mb-3">
                    <label for="account_string" class="form-label">
                        <i class="bi bi-folder2-open me-1"></i>
                        Select Account
                    </label>
                    <select class="form-select" id="account_string" name="account_string">
                        <option value="">Choose an account...</option>
                        {% for account_type, accounts in accounts_by_type.items() %}
                        <optgroup label="{{ account_type }} Accounts ({{ accounts|length }})">
                            {% for account in accounts %}
                            <option value="{{ account }}" data-sub="{{ account.sub if account.sub else '' }}"
                                data-type="{{ account_type }}" {% if account_string and account_string==account
                                %}selected{% endif %}>
                                {{ account.name }}{% if account.sub %} - {{ account.sub }}{% endif %}{% if
                                account.contra %} [Contra]{% endif %}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Please select an account.</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="from_date_str" class="form-label">
                        <i class="bi bi-calendar me-1"></i>
                        From Date (UTC)
                    </label>
                    <input type="datetime-local" class="form-control" id="from_date_str" name="from_date_str"
                        value="{{ from_date_str }}" />
                    <div class="form-text">Optional start date for range</div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="mb-3">
                    <label for="to_date_str" class="form-label">
                        <i class="bi bi-calendar2 me-1"></i>
                        To Date (UTC)
                    </label>
                    <input type="datetime-local" class="form-control" id="to_date_str" name="to_date_str"
                        value="{{ to_date_str }}" />
                    <div class="form-text">Optional end date for range (defaults to now)</div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-list-ul me-1"></i>
                        Ledger Type
                    </label>
                    <!-- Custom dropdown to allow richer styling for each option -->
                    <input type="hidden" name="ledger_type" id="ledger_type" value="{{ ledger_type or '' }}" />
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button"
                            id="ledgerTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="ledger-type-selected">{{ selected_display }}</span>
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="ledgerTypeDropdown" id="ledgerTypeMenu">
                            <li><a href="#" class="dropdown-item" data-value="" id="ledger-type-clear">Any</a></li>
                            <li>
                                <hr class="dropdown-divider" />
                            </li>
                            {% for opt in ledger_type_options %}
                            <li>
                                <a class="dropdown-item d-flex justify-content-between align-items-center" href="#"
                                    data-value="{{ opt.value }}">
                                    <div>
                                        <div>
                                            <span class="fw-bold">{{ opt.full }}</span>
                                            {% if opt.label %}
                                            <small class="text-muted">({{ opt.label }})</small>
                                            {% endif %}
                                            <small class="text-muted ms-2">{{ opt.value }}</small>
                                        </div>
                                    </div>
                                    {% if opt.icon %}
                                    <span class="badge bg-light text-dark ms-2">{{ opt.icon }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const menu = document.getElementById('ledgerTypeMenu');
                            const hidden = document.getElementById('ledger_type');
                            const selected = document.getElementById('ledger-type-selected');

                            function setSelectionFromElement(el) {
                                const v = el.getAttribute('data-value') || '';
                                hidden.value = v;
                                // clone the label content for the selected button
                                const contentDiv = el.querySelector('div');
                                if (contentDiv) {
                                    selected.innerHTML = contentDiv.innerHTML + (el.querySelector('.badge') ? ' ' + el.querySelector('.badge').textContent : '');
                                } else {
                                    selected.textContent = el.textContent.trim();
                                }
                            }

                            menu.querySelectorAll('a.dropdown-item[data-value]').forEach(function (a) {
                                a.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    setSelectionFromElement(a);
                                    // close the dropdown (Bootstrap)
                                    const dropdownToggle = document.getElementById('ledgerTypeDropdown');
                                    if (dropdownToggle) {
                                        const bs = bootstrap.Dropdown.getInstance(dropdownToggle);
                                        if (bs) bs.hide();
                                    }
                                });
                            });

                            // Clear (Any) link
                            const clearLink = document.getElementById('ledger-type-clear');
                            if (clearLink) {
                                clearLink.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    hidden.value = '';
                                    selected.textContent = 'Any';
                                    const dropdownToggle = document.getElementById('ledgerTypeDropdown');
                                    if (dropdownToggle) {
                                        const bs = bootstrap.Dropdown.getInstance(dropdownToggle);
                                        if (bs) bs.hide();
                                    }
                                });
                            }
                        });
                    </script>
                </div>
            </div>

            <div class="col-md-6">
                <div class="mb-3">
                    <label for="general_search" class="form-label"><i class="bi bi-search me-1"></i> General Search
                        (regex)</label>
                    <input type="text" class="form-control" id="general_search" name="general_search"
                        value="{{ general_search }}" placeholder="Search short_id, user_memo, description" />
                    <div class="form-text">Provide a regex to search short_id, user_memo or description</div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-list-ul me-1"></i>
                        Display Options
                    </label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="line_items" name="line_items" checked />
                        <label class="form-check-label" for="line_items">Show Line Items</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="user_memos" name="user_memos" checked />
                        <label class="form-check-label" for="user_memos">Show User Memos</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Extra filters: short_id and group_id -->
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="short_id" class="form-label"><i class="bi bi-tag me-1"></i> Short ID (regex
                        allowed)</label>
                    <input type="text" class="form-control" id="short_id" name="short_id" value="{{ short_id }}"
                        placeholder="e.g. ^abc" />
                </div>
            </div>

            <div class="col-md-6">
                <div class="mb-3">
                    <label for="group_id" class="form-label"><i class="bi bi-grid-3x3-gap me-1"></i> Group ID (regex
                        allowed)</label>
                    <input type="text" class="form-control" id="group_id" name="group_id" value="{{ group_id }}"
                        placeholder="e.g. order_.*" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 d-flex align-items-end">
                <div class="mb-3 w-100">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search me-2"></i> Search Entries
                    </button>
                </div>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <div class="mb-3 w-100">
                    <button type="button" id="clear-search" class="btn btn-outline-secondary w-100"
                        onclick="clearFilters()">
                        <i class="bi bi-x-circle me-2"></i> Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Search metadata and controls -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>Found <strong id="entries-count">0</strong> entries <span id="ledger-last-query"
            class="text-muted small ms-2"></span></div>
    <div>
        <div id="ledger-alert" class="alert alert-danger d-none py-1 px-2 mb-0" role="alert"
            style="display:inline-block"></div>
        <button id="load-more-entries" class="btn btn-sm btn-outline-primary" type="button" onclick="loadMoreEntries()">
            Load more
        </button>
    </div>
</div>

<!-- Dynamic entries container (JS will populate). Server-rendered entries remain for non-JS fallback. -->
<div id="server-entries" class="list-group">
    {% if entries %} {% for entry in entries %}
    <div class="card mb-3 entry-card">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <div><strong>J/E:</strong> {{ entry.group_id }}</div>
                    <div class="small mt-1"><strong>Short ID:</strong> {{ entry.short_id }}</div>
                    <div class="small mt-1"><strong>Op Type:</strong> {{ entry.op_type }}</div>
                    <div class="mt-1"><span class="badge bg-secondary">
                            {{ entry.ledger_type_str }}</span></div>
                </div>
                <div class="text-muted small">{{ entry.timestamp.isoformat() if entry.timestamp else '' }}</div>
            </div>

            <div class="d-flex justify-content-between mt-2">
                <div><strong>Customer ID :</strong> {{ entry.cust_id or '' }}</div>
                <div class="text-muted">{{ entry.timestamp.isoformat() if entry.timestamp else '' }}</div>
            </div>

            <div class="row mt-3 fw-bold">
                <div class="col-6">ACCOUNT</div>
                <div class="col-3 text-end">DEBIT</div>
                <div class="col-3 text-end">CREDIT</div>
            </div>

            <div class="row mt-2">
                <div class="col-6">
                    {% if entry.debit %}
                    <div>{{ entry.debit.name }} <small class="text-muted">({{ entry.debit.account_type }})</small></div>
                    <div class="small text-muted">{{ entry.debit.sub }}</div>
                    {% endif %}
                    {% if entry.credit %}
                    <div class="mt-2">{{ entry.credit.name }} <small class="text-muted">({{ entry.credit.account_type
                            }})</small></div>
                    <div class="small text-muted">{{ entry.credit.sub }}</div>
                    {% endif %}
                </div>
                <div class="col-3 text-end">{{ entry.debit.amount }} {{ entry.debit.unit }}</div>
                <div class="col-3 text-end">{{ entry.credit.amount }} {{ entry.credit.unit }}</div>
            </div>

            <div class="mt-3">
                <div class="fw-bold">Description</div>
                <div>{{ entry.description }}</div>
            </div>

            {% if entry.user_memo %}
            <div class="mt-2 text-muted"><strong>User Memo:</strong> {{ entry.user_memo }}</div>
            {% endif %}

            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                    data-bs-target="#raw-{{ loop.index }}">Raw JSON</button>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                    data-bs-target="#journal-{{ loop.index }}">Journal Text</button>
                {% if entry.link %}<a class="btn btn-sm btn-outline-primary" href="{{ entry.link }}"
                    target="_blank">Link</a>{% endif %}
            </div>

            <div class="collapse mt-2" id="raw-{{ loop.index }}">
                <pre class="small">{{ entry.model_dump(mode='json') | tojson(indent=2) }}</pre>
            </div>
            <div class="collapse mt-2" id="journal-{{ loop.index }}">
                <pre class="small">{{ entry.print_journal_entry() }}</pre>
            </div>
        </div>
    </div>
    {% endfor %} {% else %}
    <div class="list-group-item text-muted">No entries found.</div>
    {% endif %}
</div>

<div id="entries-container"></div>

{% endblock %} {% block extra_js %}
<script>
    // Form validation
    ; (function () {
        "use strict"
        var forms = document.querySelectorAll(".needs-validation")
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener(
                "submit",
                function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add("was-validated")
                },
                false,
            )
        })
    })()

    // Auto-update datetime-local inputs to current LOCAL time if empty
    function updateCurrentTime() {
        const pad = (n) => String(n).padStart(2, '0')
        const now = new Date()
        const local = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`
        const elFrom = document.getElementById("from_date_str")
        const elTo = document.getElementById("to_date_str")
        if (elFrom && !elFrom.value) elFrom.value = local
        if (elTo && !elTo.value) elTo.value = local
    }

    // Filter accounts by sub account and clear account selection when sub selected
    function filterBySubAccount() {
        const subFilter = document.getElementById("sub_filter").value
        const accountSelect = document.getElementById("account_string")
        const options = accountSelect.querySelectorAll("option")

        options.forEach((opt) => {
            const sub = opt.getAttribute("data-sub")
            if (!subFilter || sub === subFilter) {
                opt.style.display = ""
            } else {
                opt.style.display = "none"
            }
        })
        // If a subFilter is chosen, clear the account select so search will use the sub filter
        if (subFilter) {
            try {
                accountSelect.value = ""
            } catch (e) {
                // ignore
            }
        }
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", function () {
        updateCurrentTime()
        window.__ledger_entries_offset = 0
        window.__ledger_entries_limit = 50

        // Intercept form submit to use AJAX search instead of full page reload
        const form = document.querySelector('.needs-validation')
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault()
                // Reset paging and fetch using JS
                window.__ledger_entries_offset = 0
                const entriesContainer = document.getElementById('entries-container')
                if (entriesContainer) entriesContainer.innerHTML = ''
                fetchEntries()
            })
        }

        fetchEntries()
    })

    function clearFilters() {
        const form = document.querySelector('.needs-validation')
        if (!form) return
        const fields = ['account_string', 'sub_filter', 'short_id', 'group_id', 'from_date_str', 'to_date_str', 'ledger_type', 'general_search', 'age_hours']
        fields.forEach((name) => {
            const el = form.querySelector('[name="' + name + '"]')
            if (el) {
                if (el.type === 'checkbox') {
                    el.checked = false
                } else {
                    el.value = ''
                }
            }
        })
        // Reset checkboxes to defaults
        const li = form.querySelector('[name="line_items"]')
        if (li) li.checked = true
        const um = form.querySelector('[name="user_memos"]')
        if (um) um.checked = true

        // Reset pagination and container, then fetch
        window.__ledger_entries_offset = 0
        document.getElementById('entries-container').innerHTML = ''
        document.getElementById('server-entries').classList.remove('d-none')
        fetchEntries()
    }

    // Escape HTML to avoid XSS
    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return ""
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;")
    }

    function formatAmount(amountStr, unit) {
        if (!amountStr) return ""
        let n = Number(amountStr)
        if (isNaN(n)) return escapeHtml(amountStr + " " + (unit || ""))
        const unitStr = unit ? String(unit).toUpperCase() : ""
        if (unitStr === "MSATS") {
            n = n / 1000 // convert to sats
            // show up to 3 decimal places for sats (msats precision)
            return n.toLocaleString(undefined, { maximumFractionDigits: 3 }) + " SATS"
        }
        const opts = Number.isInteger(n)
            ? { maximumFractionDigits: 0 }
            : { maximumFractionDigits: 3 }
        return n.toLocaleString(undefined, opts) + (unitStr ? " " + unitStr : "")
    }

    function formatConversion(conv) {
        if (!conv) return "Converted N/A"
        const hive =
            conv.hive !== undefined
                ? Number(conv.hive).toLocaleString(undefined, {
                    maximumFractionDigits: 3,
                }) + " HIVE"
                : ""
        const hbd =
            conv.hbd !== undefined
                ? Number(conv.hbd).toLocaleString(undefined, {
                    maximumFractionDigits: 3,
                }) + " HBD"
                : ""
        const usd =
            conv.usd !== undefined
                ? Number(conv.usd).toLocaleString(undefined, {
                    maximumFractionDigits: 3,
                }) + " USD"
                : ""
        const sats = (() => {
            if (conv.sats_rounded !== undefined) {
                return (
                    Number(conv.sats_rounded).toLocaleString(undefined, {
                        maximumFractionDigits: 3,
                    }) + " SATS"
                )
            }
            if (conv.sats !== undefined) {
                const n = Number(conv.sats)
                if (!isNaN(n))
                    return (
                        n.toLocaleString(undefined, { maximumFractionDigits: 3 }) + " SATS"
                    )
                return String(conv.sats) + " SATS"
            }
            return ""
        })()
        return ["Converted", hive, hbd, usd, sats]
            .filter(Boolean)
            .join(" &nbsp;&nbsp; ")
    }

    async function fetchEntries() {
        const params = new URLSearchParams()
        const form = document.querySelector(".needs-validation")
        if (!form) return

        function getFieldValue(name) {
            const el = form.querySelector('[name="' + name + '"]')
            if (!el) return ''
            if (el.type === 'checkbox') return el.checked ? 'on' : ''
            return el.value || ''
        }

        const account = getFieldValue('account_string')
        const sub = getFieldValue('sub_filter')
        const short_id = getFieldValue('short_id')
        const group_id = getFieldValue('group_id')
        const from_date = getFieldValue('from_date_str')
        const to_date = getFieldValue('to_date_str')
        const ledger_type = getFieldValue('ledger_type')
        const general_search = getFieldValue('general_search')
        const age_hours = getFieldValue('age_hours')

        // Helper: convert local datetime-local value to an ISO-like string with local TZ offset
        function localWithTz(inputVal) {
            if (!inputVal) return ''
            const d = new Date(inputVal)
            const pad = (n) => String(n).padStart(2, '0')
            const year = d.getFullYear()
            const month = pad(d.getMonth() + 1)
            const day = pad(d.getDate())
            const hours = pad(d.getHours())
            const minutes = pad(d.getMinutes())
            const seconds = pad(d.getSeconds())
            const tzOffset = -d.getTimezoneOffset()
            const sign = tzOffset >= 0 ? '+' : '-'
            const tzHours = pad(Math.floor(Math.abs(tzOffset) / 60))
            const tzMinutes = pad(Math.abs(tzOffset) % 60)
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${sign}${tzHours}:${tzMinutes}`
        }

        if (account) params.append("account_string", account)
        if (sub) params.append("sub_filter", sub)
        if (short_id) params.append("short_id", short_id)
        if (group_id) params.append("group_id", group_id)
        if (from_date) params.append("from_date_str", localWithTz(from_date))
        if (to_date) params.append("to_date_str", localWithTz(to_date))
        if (ledger_type) params.append("ledger_type", ledger_type)
        if (general_search) params.append("general_search", general_search)
        if (age_hours) params.append("age_hours", age_hours)

        // include pagination params
        const limit = 50
        const offset = window.__ledger_entries_offset || 0
        params.append("limit", String(limit))
        params.append("offset", String(offset))
        const url = "/admin/ledger-entries/data?" + params.toString()
        try {
            const res = await fetch(url)
            document.getElementById('ledger-last-query').innerText = url
            const ledgerAlert = document.getElementById('ledger-alert')
            ledgerAlert.classList.add('d-none')
            ledgerAlert.style.display = 'none'
            if (!res.ok) {
                ledgerAlert.innerText = 'Error fetching entries: ' + res.status + ' ' + res.statusText
                ledgerAlert.classList.remove('d-none')
                ledgerAlert.style.display = 'inline-block'
                document.getElementById("entries-count").innerText = 0
                document.getElementById('entries-container').innerHTML = '<div class="list-group-item text-muted">Error fetching entries.</div>'
                return
            }
            const data = await res.json()
            // update total count and entries
            window.__ledger_entries_total = data.count
            document.getElementById("entries-count").innerText = data.count
            renderEntries(data.entries || [], data.count)
            // Manage Load more button state
            const loadMoreBtn = document.getElementById("load-more-entries")
            const offset = window.__ledger_entries_offset || 0
            const limit = window.__ledger_entries_limit || 50
            if (offset + (data.entries || []).length >= (data.count || 0)) {
                loadMoreBtn.disabled = true
                loadMoreBtn.innerText = "No more"
            } else {
                loadMoreBtn.disabled = false
                loadMoreBtn.innerText = "Load more"
            }
        } catch (e) {
            console.error("Error fetching entries", e)
            const ledgerAlert = document.getElementById('ledger-alert')
            ledgerAlert.innerText = 'Error fetching entries: ' + e.message
            ledgerAlert.classList.remove('d-none')
            ledgerAlert.style.display = 'inline-block'
        }
    }

    function renderEntries(entries) {
        const container = document.getElementById("entries-container")
        const serverContainer = document.getElementById("server-entries")
        if (!container) return
        if (serverContainer) serverContainer.classList.add("d-none")

        if (!entries || entries.length === 0) {
            container.innerHTML =
                '<div class="list-group-item text-muted">No entries found.</div>'
            return
        }

        // Append entries (supports incremental load)
        const startingIdx = window.__ledger_entries_offset || 0
        // Append generated HTML to the container
        // Append generated HTML to the container
        const html = entries
            .map((entry, idx) => {
                const debit = entry.debit || {}
                const credit = entry.credit || {}
                const conv = entry.conversion || {}
                const date = entry.timestamp ? new Date(entry.timestamp) : null
                const formattedDate = date
                    ? date.toLocaleString(undefined, {
                        year: "numeric",
                        month: "short",
                        day: "2-digit",
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                        hour12: false,
                    })
                    : ""

                const debitAmt = formatAmount(debit.amount, debit.unit)
                const creditAmt = formatAmount(credit.amount, credit.unit)

                const conversionLine = formatConversion(conv.debit || conv)

                return `
                <div class="card mb-3 entry-card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between">
                      <div>
                        <div><strong>J/E:</strong> ${escapeHtml(entry.group_id || "")}</div>
                        <div class="small mt-1"><strong>Short ID:</strong> ${escapeHtml(entry.short_id || "")}</div>
                        <div class="small mt-1"><strong>Op Type:</strong> ${escapeHtml(entry.op_type || "")}</div>
                        <div class="mt-1"><span class="badge bg-secondary">${escapeHtml(entry.ledger_type_str || entry.ledger_type || "")}</span></div>
                      </div>
                      <div class="text-muted small">${escapeHtml(formattedDate)}</div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                      <div><strong>Customer ID :</strong> ${escapeHtml(entry.cust_id || "")}</div>
                      <div class="text-muted">${escapeHtml(formattedDate)}</div>
                    </div>

                    <div class="row mt-3 fw-bold">
                      <div class="col-6">ACCOUNT</div>
                      <div class="col-3 text-end">DEBIT</div>
                      <div class="col-3 text-end">CREDIT</div>
                    </div>
                    <hr />

                    <div class="row">
                      <div class="col-6">
                        ${escapeHtml(debit.name || "")} (${escapeHtml(debit.account_type || "")})<div class="text-muted small">${escapeHtml(debit.sub || "")}</div>
                      </div>
                      <div class="col-3 text-end">${escapeHtml(debitAmt)}</div>
                      <div class="col-3 text-end">&nbsp;</div>
                    </div>

                    <div class="row mt-2">
                      <div class="col-6">${escapeHtml(credit.name || "")} (${escapeHtml(credit.account_type || "")})<div class="text-muted small">${escapeHtml(credit.sub || "")}</div></div>
                      <div class="col-3 text-end">&nbsp;</div>
                      <div class="col-3 text-end">${escapeHtml(creditAmt)}</div>
                    </div>

                    <div class="row mt-3">
                      <div class="col-12">${conversionLine}</div>
                    </div>

                    <div class="row mt-2">
                      <div class="col-12"><strong>DESCRIPTION</strong><p>${escapeHtml(entry.description || "")}</p>
                      ${entry.user_memo ? `<div class="mt-1"><strong>User Memo:</strong> <span class="text-muted small">${escapeHtml(entry.user_memo)}</span></div>` : ""}
                      </div>
                    </div>

                    <div class="mt-2">
                      <button class="btn btn-sm btn-outline-secondary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#raw-${startingIdx + idx}">Raw JSON</button>
                      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#journal-${startingIdx + idx}">Journal Text</button>
                      ${entry.link ? `<a class="btn btn-sm btn-outline-primary ms-2" href="${escapeHtml(entry.link)}" target="_blank">ðŸ”— Link</a>` : ""}
                    </div>

                    <div class="collapse mt-2" id="raw-${startingIdx + idx}"><pre>${escapeHtml(JSON.stringify(entry, null, 2))}</pre></div>
                    <div class="collapse mt-2" id="journal-${startingIdx + idx}"><pre class="small">${escapeHtml(entry.journal || "")}</pre></div>
                  </div>
                </div>`
            })
            .join("")

        // If offset is zero, replace; otherwise append
        const offset = window.__ledger_entries_offset || 0
        if (offset === 0) {
            container.innerHTML = html
        } else {
            container.insertAdjacentHTML("beforeend", html)
        }
    }

    function loadMoreEntries() {
        const limit = window.__ledger_entries_limit || 50
        window.__ledger_entries_offset =
            (window.__ledger_entries_offset || 0) + limit
        fetchEntries()
    }
</script>
{% endblock %}
