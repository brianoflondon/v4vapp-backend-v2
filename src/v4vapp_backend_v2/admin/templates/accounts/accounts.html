{% extends "base.html" %}

{% block extra_css %}
<style>
    .account-form {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .form-select {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
    }

    .form-check-label {
        font-weight: 500;
        color: var(--bs-body-color);
    }

    .account-info {
        background-color: var(--bs-secondary-bg);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .account-count {
        color: var(--v4v-secondary);
        font-size: 0.9rem;
    }

    .form-select.border-success {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        transition: all 0.3s ease;
    }

    #sub_filter {
        background-color: var(--bs-secondary-bg);
    }

    option[style*="display: none"] {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Account Selection Form -->
            <div class="card account-form">
                <h3 class="mb-4">
                    <i class="bi bi-bank me-2"></i>
                    Select Account for Balance Report
                </h3>

                <form method="post" action="/admin/accounts/balance" class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="sub_filter" class="form-label">
                                    <i class="bi bi-funnel me-1"></i>
                                    Filter by Sub Account
                                </label>


                                <select class="form-select" id="sub_filter" onchange="filterBySubAccount()">
                                    <option value="">All Sub Accounts</option>
                                    {% set all_subs = [] %}
                                    {% for account_type, accounts in accounts_by_type.items() %}
                                    {% for account in accounts %}
                                    {% if account.sub and account.sub not in all_subs %}
                                    {% set _ = all_subs.append(account.sub) %}
                                    {% endif %}
                                    {% endfor %}
                                    {% endfor %}
                                    {% for sub in all_subs|sort %}
                                    <option value="{{ sub }}">{{ sub }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="account_string" class="form-label">
                                    <i class="bi bi-folder2-open me-1"></i>
                                    Select Account
                                </label>
                                <select class="form-select" id="account_string" name="account_string" required>
                                    <option value="">Choose an account...</option>
                                    {% for account_type, accounts in accounts_by_type.items() %}
                                    <optgroup label="{{ account_type }} Accounts ({{ accounts|length }})">
                                        {% for account in accounts %}
                                        <option value="{{ account }}"
                                            data-sub="{{ account.sub if account.sub else '' }}"
                                            data-type="{{ account_type }}" data-name="{{ account.name }}">
                                            {{ account.name }}
                                            {% if account.sub %} - {{ account.sub }}{% endif %}
                                            {% if account.contra %} [Contra]{% endif %}
                                        </option>
                                        {% endfor %}
                                    </optgroup>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">
                                    Please select an account.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-center justify-content-end">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="exclude_vsc_liability" checked>
                                <label class="form-check-label ms-2" for="exclude_vsc_liability">Exclude VSC
                                    Liability</label>
                                <button class="btn btn-link p-0 ms-2" type="button" data-bs-toggle="tooltip"
                                    title="When checked (default), VSC Liability accounts and their sub-accounts are hidden from both selectors.">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="as_of_date_str" class="form-label">
                                    <i class="bi bi-calendar me-1"></i>
                                    As of Date (UTC)
                                </label>
                                <input type="datetime-local" class="form-control" id="as_of_date_str"
                                    name="as_of_date_str">
                                <div class="form-text">Leave blank for current time</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="age_hours" class="form-label">
                                    <i class="bi bi-clock me-1"></i>
                                    Age Filter (Hours)
                                </label>
                                <input type="number" class="form-control" id="age_hours" name="age_hours" value="0"
                                    min="0" step="1">
                                <div class="form-text">0 = no age filter</div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-list-ul me-1"></i>
                                    Display Options
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="line_items" name="line_items"
                                        checked>
                                    <label class="form-check-label" for="line_items">
                                        Show Line Items
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="user_memos" name="user_memos"
                                        checked>
                                    <label class="form-check-label" for="user_memos">
                                        Show User Memos
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 d-flex align-items-end">
                            <div class="mb-3 w-100">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-calculator me-2"></i>
                                    Generate Balance Report
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Account Summary -->
            <div class="account-info">
                <h5 class="mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Available Accounts Summary
                </h5>
                <div class="row">
                    {% for account_type, accounts in accounts_by_type.items() %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="fw-medium">{{ account_type }}:</span>
                            <span class="account-count">{{ accounts|length }} accounts</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        Total: {% set total_count = 0 %}{% for account_type, accounts in accounts_by_type.items() %}{%
                        set total_count = total_count + accounts|length %}{% endfor %}{{ total_count }} accounts across
                        all types
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    (function () {
        'use strict';

        // Add custom validation
        var forms = document.querySelectorAll('.needs-validation');

        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();

    // Auto-update datetime field to current time
    function updateCurrentTime() {
        const now = new Date();
        // Convert to UTC and format for datetime-local input
        const utcDate = new Date(now.getTime() + (now.getTimezoneOffset() * 60000));
        const isoString = utcDate.toISOString().slice(0, 16);
        document.getElementById('as_of_date_str').value = isoString;
    }

    // Filter accounts by sub account (supports excluding VSC Liability)
    function filterBySubAccount() {
        const subFilter = document.getElementById('sub_filter').value;
        const accountSelect = document.getElementById('account_string');
        const options = Array.from(accountSelect.querySelectorAll('option'));
        const optgroups = Array.from(accountSelect.querySelectorAll('optgroup'));
        const excludeVsc = document.getElementById('exclude_vsc_liability')?.checked;

        // Reset selection
        accountSelect.value = '';

        function isVscOption(opt) {
            return opt.getAttribute('data-name') === 'VSC Liability';
        }

        // If no filter, show/hide options according to the exclude checkbox
        if (!subFilter) {
            options.forEach(option => {
                if (option.value === '') { option.style.display = ''; return; }
                if (excludeVsc && isVscOption(option)) option.style.display = 'none';
                else option.style.display = '';
            });
            optgroups.forEach(optgroup => {
                const hasVisible = Array.from(optgroup.querySelectorAll('option')).some(o => o.value !== '' && o.style.display !== 'none');
                optgroup.style.display = hasVisible ? '' : 'none';
            });
            return;
        }

        // With an active sub-filter: hide excluded VSC options even if they match
        const visibleOptgroups = new Set();
        let matchingOptions = [];

        options.forEach(option => {
            if (option.value === '') { option.style.display = ''; return; }
            if (excludeVsc && isVscOption(option)) { option.style.display = 'none'; return; }
            const optionSub = option.getAttribute('data-sub');
            const optionType = option.getAttribute('data-type');

            if (optionSub === subFilter) {
                option.style.display = '';
                visibleOptgroups.add(optionType);
                matchingOptions.push(option);
            } else {
                option.style.display = 'none';
            }
        });

        optgroups.forEach(optgroup => {
            const hasVisible = Array.from(optgroup.querySelectorAll('option')).some(o => o.value !== '' && o.style.display !== 'none');
            optgroup.style.display = hasVisible ? '' : 'none';
        });

        // If only one matching option, auto-select it
        if (matchingOptions.length === 1) {
            accountSelect.value = matchingOptions[0].value;
            accountSelect.classList.add('border-success');
            setTimeout(() => accountSelect.classList.remove('border-success'), 2000);
        }
    }

    // Rebuild the Sub Account filter based on currently-available accounts
    function rebuildSubFilter() {
        const excludeVsc = document.getElementById('exclude_vsc_liability')?.checked;
        const accountSelect = document.getElementById('account_string');
        const subFilter = document.getElementById('sub_filter');
        const options = Array.from(accountSelect.querySelectorAll('option')).filter(o => o.value !== '');

        const subsSet = new Set();
        options.forEach(o => {
            if (excludeVsc && o.getAttribute('data-name') === 'VSC Liability') return;
            const s = o.getAttribute('data-sub');
            if (s) subsSet.add(s);
        });

        const prevValue = subFilter.value;
        subFilter.innerHTML = '<option value="">All Sub Accounts</option>';
        Array.from(subsSet).sort().forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            subFilter.appendChild(opt);
        });

        if (Array.from(subFilter.options).some(opt => opt.value === prevValue)) subFilter.value = prevValue;
        else subFilter.value = '';
    }

    // Wire up the exclude checkbox and initialize tooltip, then apply default filter
    (function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });

        const excludeCheckbox = document.getElementById('exclude_vsc_liability');
        if (excludeCheckbox) {
            excludeCheckbox.addEventListener('change', () => {
                rebuildSubFilter();
                filterBySubAccount();
            });
            rebuildSubFilter();
            filterBySubAccount();
        } else {
            filterBySubAccount();
        }
    })();

    // Update time every minute
    setInterval(updateCurrentTime, 60000);
</script>
{% endblock %}
